<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>CloudBar Shop</title>
  <style>
    /* ====== –ë–ê–ó–û–í–´–ï –§–ò–ö–°–´ –î–õ–Ø MINI APP ====== */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { margin: 0; width: 100%; max-width: 100vw; overflow-x: hidden; }
    :root{
      --bg:#0e0f12;
      --panel:#14161b;
      --line:#2a2d35;
      --text:#eaeaea;
      --muted:#9aa1a9;
      --brand:#6f63ff;
      --brand-2:#8b5cf6;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    body{
      background: var(--bg);
      color: var(--text);
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      padding-top: var(--safe-top);
      padding-bottom: var(--safe-bottom);
    }
    a{color:inherit}

    /* ====== –®–ê–ü–ö–ê ====== */
    .header{
      position: sticky; top:0;
      z-index: 5;
      background: linear-gradient(180deg, rgba(20,22,27,.9), rgba(20,22,27,.7));
      backdrop-filter: blur(6px);
      border-bottom: 1px solid var(--line);
    }
    .header .row{
      display:flex; align-items:center; gap:12px;
      padding:10px 12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 0;
    }
    .brand .logo{
      width:28px; height:28px; border-radius:8px;
      display:grid; place-items:center;
      background: radial-gradient(100% 100% at 0% 0%, #7aa7ff 0%, #6f63ff 65%, #2b2c6f 100%);
      color:#fff; font-weight:700; letter-spacing:.5px;
      font-size:12px;
      box-shadow: 0 2px 8px rgba(0,0,0,.25) inset, 0 1px 0 rgba(255,255,255,.08);
    }
    .brand .title{
      display:flex; flex-direction:column; line-height:1.05;
    }
    .brand b{font-weight:700; font-size:16px}
    .brand small{color:var(--muted)}

    .header .search{
      flex:1 1 auto; min-width: 120px;
      display:flex; align-items:center;
      background: #101218;
      border:1px solid var(--line);
      border-radius:12px;
      padding: 6px 10px;
    }
    .header .search input{
      width:100%; outline:none; border:none; background:transparent;
      color:var(--text); font-size:14px;
    }
    .header .actions{
      display:flex; align-items:center; gap:10px;
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px; padding:10px 14px; font-weight:600;
      background:#1a1d25; border:1px solid var(--line); color:#fff;
      border-radius:12px; cursor:pointer;
      transition: .15s ease;
    }
    .btn:hover{ background:#1d212a }
    .btn.primary{ background:var(--brand); border-color:transparent }
    .btn.primary:hover{ filter: brightness(1.06) }
    .cartButton{
      position:relative; width:40px; height:40px; border-radius:12px;
      display:grid; place-items:center; background:#1a1d25; border:1px solid var(--line);
      cursor:pointer;
    }
    .cartButton .badge{
      position:absolute; top:-6px; right:-6px;
      min-width:18px; height:18px; padding:0 5px;
      display:grid; place-items:center;
      background: #ff6b6b; color:#fff;
      border-radius: 9px; font-size:12px; font-weight:700;
      border:2px solid var(--panel);
    }

    /* ====== –¢–ê–ë–´ (–∫–∞—Ç–µ–≥–æ—Ä–∏–∏) ====== */
    .tabsWrap{
      position: sticky; top:56px; z-index: 4;
      background: var(--panel);
      border-bottom:1px solid var(--line);
    }
    .tabs{
      display:flex; gap:8px; padding:10px 12px;
      overflow-x:auto; -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
    }
    .tab{
      flex:0 0 auto; padding:8px 12px; font-weight:600;
      border:1px solid var(--line); background:#0f1117;
      color:var(--text); border-radius:999px; cursor:pointer;
    }
    .tab.active{ background:#26315f; border-color:#4050b7; }

    /* ====== –ì–†–ò–î –¢–û–í–ê–†–û–í ====== */
    .section{ padding:16px 12px 28px }
    .grid{
      display:grid; gap:16px;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    }
    @media (max-width: 480px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      display:flex; flex-direction:column;
      background: var(--panel);
      border:1px solid var(--line);
      border-radius:18px; overflow:hidden;
    }
    .card .pic{
      padding:10px; border-bottom:1px solid var(--line); background:#0f1117;
    }
    .card img{
      width:100%; height:auto; aspect-ratio:1/1; object-fit:cover; background:#0e0f12;
      border-radius:12px;
    }
    .card .meta{ padding:12px 12px 8px; min-height:74px }
    .card .cat{ color:var(--muted); font-size:12px; margin-bottom:4px }
    .card .title{ font-weight:700; }
    .card .foot{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px 12px }
    .price{ font-weight:800; }
    .muted{ color:var(--muted); }

    /* ====== DRAWER –ö–û–†–ó–ò–ù–´ ====== */
    .overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.5);
      opacity:0; pointer-events:none; transition:opacity .25s ease; z-index:999;
    }
    .overlay_show{ opacity:1; pointer-events:auto }

    .drawer{
      position:fixed; right:0; top:0; bottom:0;
      width:min(380px, 100vw); max-width:100vw;
      background:var(--panel); border-left:1px solid var(--line);
      transform:translateX(100%); transition: transform .25s ease; z-index:1000;
      display:flex; flex-direction:column;
    }
    .drawer_open{ transform:translateX(0) }

    .drawer header{
      position: sticky; top:0; z-index:1;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 14px; background:var(--panel); border-bottom:1px solid var(--line);
      font-weight:800;
    }
    .drawer header .close{
      width:32px; height:32px; border-radius:10px; cursor:pointer;
      display:grid; place-items:center; border:1px solid var(--line); background:#1a1d25; color:#fff;
    }

    .drawer .body{
      flex:1 1 auto; min-height:0;
      overflow-y:auto; padding:12px 14px 14px; display:flex; flex-direction:column; gap:12px;
    }
    .cartLine{
      display:grid; grid-template-columns:56px 1fr auto; gap:10px;
      padding:10px; border:1px solid var(--line); border-radius:12px; background:#101218;
      align-items:center;
    }
    .cartLine img{ width:56px; height:56px; border-radius:8px; object-fit:cover }
    .qty{
      display:flex; align-items:center; gap:8px;
      border:1px solid var(--line); border-radius:999px; padding:4px 8px; background:#0f1117;
    }
    .qty button{
      width:22px; height:22px; display:grid; place-items:center; border-radius:50%;
      border:1px solid var(--line); background:#1a1d25; color:#fff; cursor:pointer;
    }

    .drawer .form .row{ display:flex; flex-direction:column; gap:6px }
    .drawer select, .drawer input, .drawer textarea{
      width:100%; padding:12px 12px; border-radius:12px; border:1px solid var(--line);
      background:#0f1117; color:#fff; outline:none;
    }
    .drawer textarea{ min-height:80px; resize:vertical }

    .drawer .footer{
      position:sticky; bottom:0; padding:12px 14px; background:var(--panel); border-top:1px solid var(--line);
      display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center;
    }
    .total{ font-weight:800 }

    .note{
      margin:0; color:#9aa1a9; font-size:12px
    }
  </style>
</head>
<body>

  <!-- ====== HEADER ====== -->
  <header class="header">
    <div class="row">
      <div class="brand">
        <div class="logo">CB</div>
        <div class="title">
          <b>CloudBar</b>
          <small>mini shop</small>
        </div>
      </div>

      <label class="search">
        <input id="search" type="search" placeholder="–ü–æ–∏—Å–∫ –≤–∫—É—Å–∞...">
      </label>

      <div class="actions">
        <button id="openCart" class="cartButton" title="–ö–æ—Ä–∑–∏–Ω–∞">
          üõí
          <span id="cartBadge" class="badge" hidden>0</span>
        </button>
      </div>
    </div>
  </header>

  <!-- ====== CATEGORIES ====== -->
  <div class="tabsWrap">
    <div id="tabs" class="tabs"></div>
  </div>

  <!-- ====== GRID ====== -->
  <section class="section">
    <div id="grid" class="grid"></div>
  </section>

  <!-- ====== OVERLAY & DRAWER ====== -->
  <div id="overlay" class="overlay"></div>

  <aside id="cart" class="drawer" aria-hidden="true">
    <header>
      <span>–ö–æ—Ä–∑–∏–Ω–∞</span>
      <button id="closeCart" class="close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
    </header>

    <div class="body">
      <div id="cartList" class="list"></div>

      <form id="orderForm" class="form">
        <div class="row">
          <select name="payment" required>
            <option>–û–Ω–ª–∞–π–Ω-–ø–µ—Ä–µ–≤–æ–¥–æ–º</option>
            <option>–ù–∞–ª–∏—á–Ω—ã–º–∏ –∫—É—Ä—å–µ—Ä—É</option>
          </select>

          <select name="delivery" required>
            <option>–î–æ—Å—Ç–∞–≤–∫–∞</option>
            <option>–°–∞–º–æ–≤—ã–≤–æ–∑</option>
          </select>

          <input name="name" placeholder="–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è" required>
          <input name="username" placeholder="@username –≤ Telegram (–ø–æ –∂–µ–ª–∞–Ω–∏—é)">
          <input name="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" required>
          <input name="address" placeholder="–ê–¥—Ä–µ—Å">
          <textarea name="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
          <p class="note">–ù–∞–∂–∏–º–∞—è ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑¬ª, –≤—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö.</p>
        </div>
      </form>
    </div>

    <div class="footer">
      <div class="total" id="totalBox">–ò—Ç–æ–≥–æ: 0 Kƒç</div>
      <button type="submit" form="orderForm" class="btn primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
    </div>
  </aside>

  <script>
    /* ====== –ö–û–ù–§–ò–ì ====== */
    // –í–°–¢–ê–í–¨ –°–í–û–ô URL –í–ï–ë-–ü–†–ò–õ–û–ñ–ï–ù–ò–Ø APPS SCRIPT:
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbx4P7kHLxXLoKydNMzkqOumae5FpXyNACs1iI7MbBSsDBNNpvQsSby0njaB3BjNbMeRsQ/exec';
    const CURRENCY = 'Kƒç';

    /* ====== –î–ê–ù–ù–´–ï –¢–û–í–ê–†–û–í ====== */
    const items = [
      { id:1,  cat:'VOEX Blueberry Bubble Gum', title:'–ß–µ—Ä–Ω–∏—á–Ω–∞—è –∂–µ–≤–∞—Ç–µ–ª—å–Ω–∞—è —Ä–µ–∑–∏–Ω–∫–∞', img:'blueberry-bubble-gum.jpg.jpg', price:300 },
      { id:2,  cat:'VOEX Blueberry Coconut',    title:'–ß–µ—Ä–Ω–∏–∫–∞ –ö–æ–∫–æ—Å',                 img:'blueberry-coconut.jpg.jpg',    price:300 },
      { id:3,  cat:'VOEX Green Grape Rose',     title:'–ó–µ–ª—ë–Ω–∞—è –≤–∏–Ω–æ–≥—Ä–∞–¥–Ω–∞—è —Ä–æ–∑–∞',     img:'green-grape-rose.jpg.jpg',     price:300 },
      { id:4,  cat:'VOEX Jasmine Raspberry',    title:'–ñ–∞—Å–º–∏–Ω–æ–≤–∞—è –º–∞–ª–∏–Ω–∞',            img:'jasmine-raspberry.jpg.jpg',    price:300 },
      { id:5,  cat:'VOEX Pink Lemonade',        title:'–†–æ–∑–æ–≤—ã–π –ª–∏–º–æ–Ω–∞–¥',              img:'pink-lemonade.jpg.jpg',        price:300 },
    ];

    /* ====== –°–û–°–¢–û–Ø–ù–ò–ï ====== */
    const state = {
      cat: '–í—Å–µ',
      search: '',
      cart: new Map(), // id -> qty
    };

    /* ====== –£–¢–ò–õ–ò–¢–´ ====== */
    const money = v => `${v} ${CURRENCY}`;
    const byId  = sel => document.getElementById(sel);

    /* ====== –†–ï–ù–î–ï–† –ö–ê–¢–ï–ì–û–†–ò–ô ====== */
    function renderTabs(){
      const tabs = byId('tabs');
      const cats = ['–í—Å–µ', ...Array.from(new Set(items.map(i=>i.cat)))];
      tabs.innerHTML = cats.map(c=>`
        <button class="tab ${c===state.cat?'active':''}" data-cat="${c}">${c}</button>
      `).join('');
      tabs.querySelectorAll('.tab').forEach(btn=>{
        btn.addEventListener('click', e=>{
          const cat = e.currentTarget.dataset.cat;
          state.cat = cat;
          renderTabs();
          renderGrid();
          window.scrollTo({top:0, behavior:'smooth'});
        });
      });
    }

    /* ====== –†–ï–ù–î–ï–† –ì–†–ò–î–ê ====== */
    function renderGrid(){
      const grid = byId('grid');
      const q = state.search.trim().toLowerCase();
      const filtered = items.filter(it=>{
        const okCat = state.cat==='–í—Å–µ' || it.cat===state.cat;
        const okSearch = !q || (it.title.toLowerCase().includes(q) || it.cat.toLowerCase().includes(q));
        return okCat && okSearch;
      });

      grid.innerHTML = filtered.map(it=>`
        <div class="card">
          <div class="pic"><img src="./img/${it.img}" alt=""></div>
          <div class="meta">
            <div class="cat">${it.cat}</div>
            <div class="title">${it.title}</div>
          </div>
          <div class="foot">
            <div class="price">${money(it.price)}</div>
            <button class="btn" data-add="${it.id}">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
          </div>
        </div>
      `).join('');

      grid.querySelectorAll('[data-add]').forEach(btn=>{
        btn.addEventListener('click', e=>{
          add(+e.currentTarget.dataset.add);
        });
      });
    }

    /* ====== –ö–û–†–ó–ò–ù–ê ====== */
    function add(id, q=1){
      const cur = state.cart.get(id) || 0;
      state.cart.set(id, Math.max(0, cur + q));
      if(state.cart.get(id)===0) state.cart.delete(id);
      renderCart();
    }
    function setQty(id, q){
      state.cart.set(id, Math.max(0, q));
      if(state.cart.get(id)===0) state.cart.delete(id);
      renderCart();
    }

    function cartArray(){
      return Array.from(state.cart.entries())
        .map(([id, qty])=>{
          const it = items.find(x=>x.id===id);
          return { ...it, qty, price_total: it.price * qty };
        })
        .sort((a,b)=> a.cat.localeCompare(b.cat) || a.title.localeCompare(b.title));
    }

    function renderCart(){
      const list = byId('cartList');
      const badge = byId('cartBadge');
      const totalBox = byId('totalBox');

      const arr = cartArray();
      const qty = arr.reduce((s,i)=> s + i.qty, 0);
      const total = arr.reduce((s,i)=> s + i.price_total, 0);

      if(qty>0){ badge.hidden=false; badge.textContent = qty; } else { badge.hidden=true; }

      list.innerHTML = arr.length ? arr.map(i=>`
        <div class="cartLine">
          <img src="./img/${i.img}" alt="">
          <div>
            <div class="title"><b>${i.cat.split(' ').slice(0,2).join(' ')}</b> ${i.title}</div>
            <div class="muted">${money(i.price)} –∑–∞ —à—Ç.</div>
          </div>
          <div style="text-align:right">
            <div class="qty">
              <button aria-label="–ú–∏–Ω—É—Å" data-minus="${i.id}">‚àí</button>
              <span>${i.qty}</span>
              <button aria-label="–ü–ª—é—Å" data-plus="${i.id}">+</button>
            </div>
            <div class="price muted" style="margin-top:6px">${money(i.price_total)}</div>
          </div>
        </div>
      `).join('') : `<div class="muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>`;

      list.querySelectorAll('[data-minus]').forEach(b=> b.addEventListener('click', e=> add(+e.currentTarget.dataset.minus, -1)));
      list.querySelectorAll('[data-plus]').forEach(b=> b.addEventListener('click',  e=> add(+e.currentTarget.dataset.plus, +1)));

      totalBox.textContent = `–ò—Ç–æ–≥–æ: ${money(total)}`;
    }

    /* ====== –û–¢–ö–†–´–¢–ò–ï/–ó–ê–ö–†–´–¢–ò–ï DRAWER ====== */
    const cart    = byId('cart');
    const overlay = byId('overlay');
    const openBtn = byId('openCart');
    const closeBtn= byId('closeCart');

    function openCart(){
      cart.classList.add('drawer_open');
      overlay.classList.add('overlay_show');
    }
    function closeCart(){
      cart.classList.remove('drawer_open');
      overlay.classList.remove('overlay_show');
    }
    openBtn.addEventListener('click', openCart);
    closeBtn.addEventListener('click', closeCart);
    overlay.addEventListener('click', closeCart);
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeCart(); });

    /* ====== –ü–û–ò–°–ö ====== */
    byId('search').addEventListener('input', e=>{
      state.search = e.target.value; renderGrid();
    });

    /* ====== –û–¢–ü–†–ê–í–ö–ê –ó–ê–ö–ê–ó–ê ====== */
    byId('orderForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const arr = cartArray();
      if(!arr.length){
        alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞'); return;
      }
      const data = Object.fromEntries(new FormData(e.currentTarget).entries());
      const payload = {
        items: arr.map(it=>({ id:it.id, cat:it.cat, title:it.title, qty:it.qty, price:it.price, price_total:it.price_total })),
        total: arr.reduce((s,i)=> s+i.price_total, 0),
        currency: CURRENCY,
        payment: data.payment,
        delivery: data.delivery,
        customer: {
          name: data.name,
          username: data.username,
          phone: data.phone,
          address: data.address,
          comment: data.comment
        }
      };

      try{
        // –í no-cors –±—Ä–∞—É–∑–µ—Ä –Ω–µ –¥–∞—Å—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç, –Ω–æ –∑–∞–ø—Ä–æ—Å —É–π–¥—ë—Ç
        await fetch(GAS_URL, {
          method:'POST',
          mode: 'no-cors',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        alert('‚úÖ –ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
        state.cart.clear(); renderCart(); closeCart();
        e.currentTarget.reset();
      }catch(err){
        console.error(err);
        alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: '+err.message);
      }
    });

    /* ====== –°–¢–ê–†–¢ ====== */
    renderTabs(); renderGrid(); renderCart();
  </script>
</body>
</html>
