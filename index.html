<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CloudBar Shop</title>
  <style>
    :root{
      --bg:#0e0f12;
      --panel:#14161b;
      --accent:#673cff;
      --muted:#aeb4c2;
      --border:#2a2d35;
      --ok:#6ddc8d;
      --danger:#ff5e6a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:#fff;
      font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    header{
      position:sticky;top:0;z-index:10;
      background:var(--panel);
      border-bottom:1px solid var(--border);
      padding:12px 16px;
      display:flex;gap:12px;align-items:center;
    }
    input[type=search]{
      flex:1 1 auto; min-width:180px;
      background:#0e0f12; color:#eaeaea;
      border:1px solid var(--border); border-radius:10px;
      padding:10px 12px;
    }
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 16px 0}
    .tab{
      padding:8px 12px;border:1px solid var(--border);border-radius:20px;
      cursor:pointer;font-size:14px;background:var(--panel);
    }
    .tab.active{background:var(--accent);border-color:var(--accent)}
    .grid{
      display:grid;gap:16px;padding:16px;
      grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
    }
    .card{
      background:var(--panel);
      border:1px solid var(--border); border-radius:16px;
      overflow:hidden; display:flex; flex-direction:column;
    }
    .card img{width:100%;aspect-ratio:1/1;object-fit:cover;background:#0e0f12}
    .card .p{padding:12px;display:flex;flex-direction:column;gap:6px}
    .title{min-height:44px;color:#fff}
    .muted{opacity:.75;color:var(--muted)}
    .price{font-weight:700}
    button{
      cursor:pointer;border:1px solid var(--accent);background:var(--accent);
      color:#fff;border-radius:10px;padding:8px 10px;
    }
    .btn-outline{background:transparent;color:#fff}
    .fab{
      position:fixed;right:22px;bottom:22px;
      background:var(--accent);width:52px;height:52px;border-radius:50%;
      display:grid;place-items:center;border:none;color:#fff;font-weight:700;
      z-index:11;
    }

    /* –ö–æ—Ä–∑–∏–Ω–∞ (–≤—ã–¥–≤–∏–∂–Ω–æ–π —è—â–∏–∫) */
    .drawer{
      position:fixed; right:0; top:0; bottom:0;
      width:380px; max-width:100%;
      background:var(--panel);
      border-left:1px solid var(--border);
      transform:translateX(100%); transition:transform .25s ease;
      z-index:1000;
      display:flex; flex-direction:column;
    }
    .drawer_open{ transform:translateX(0); }

    .drawer header{
      position:sticky; top:0; z-index:1;
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 16px; background:var(--panel);
      border-bottom:1px solid var(--border);
    }
    .drawer header .close{
      width:34px; height:34px; border-radius:8px;
      background:transparent; border:1px solid var(--border); color:#fff;
    }

    .cart-list{padding:12px; display:flex; flex-direction:column; gap:10px; overflow:auto}
    .row{display:flex; gap:10px; align-items:center; justify-content:space-between;
      border:1px solid var(--border); padding:10px;border-radius:10px;}
    .qty{display:flex; gap:6px; align-items:center}
    .qty button{width:30px;height:30px; padding:0}

    .panel{padding:12px; display:flex; flex-direction:column; gap:10px}
    select, textarea, input[type=text], input[type=tel]{
      width:100%; background:#0e0f12; color:#eaeaea;
      border:1px solid var(--border); border-radius:10px; padding:10px;
    }
    textarea{min-height:90px; resize:vertical}
    .total{padding:12px;border-top:1px solid var(--border); font-weight:700}

    /* –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ */
    .overlay{
      position:fixed; inset:0; background:#0008;
      opacity:0; pointer-events:none; transition:opacity .25s; z-index:999;
    }
    .overlay_show{opacity:1; pointer-events:auto}
  </style>
</head>
<body>

  <header>
    <input id="search" type="search" placeholder="–ü–æ–∏—Å–∫..." />
  </header>

  <div class="tabs" id="tabs"></div>
  <div class="grid" id="grid"></div>

  <!-- –ü–ª–∞–≤–∞—é—â–∞—è –∫–Ω–æ–ø–∫–∞ "–ö–æ—Ä–∑–∏–Ω–∞" -->
  <button class="fab" id="openCart">üõí</button>

  <!-- –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ -->
  <div class="overlay" id="overlay"></div>

  <!-- –í—ã–¥–≤–∏–∂–Ω–∞—è –∫–æ—Ä–∑–∏–Ω–∞ -->
  <aside class="drawer" id="cart">
    <header>
      <div>–ö–æ—Ä–∑–∏–Ω–∞</div>
      <button class="close" id="closeCart">‚úï</button>
    </header>

    <div class="cart-list" id="cartList"></div>

    <div class="panel">
      <select id="paymentSel">
        <option>–û–Ω–ª–∞–π–Ω-–ø–µ—Ä–µ–≤–æ–¥–æ–º</option>
        <option>–ù–∞–ª–∏—á–Ω—ã–º–∏ –∫—É—Ä—å–µ—Ä—É</option>
      </select>

      <select id="deliverySel">
        <option>–î–æ—Å—Ç–∞–≤–∫–∞</option>
        <option>–°–∞–º–æ–≤—ã–≤–æ–∑</option>
      </select>

      <input id="nameInput" type="text" placeholder="–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è" />
      <input id="usernameInput" type="text" placeholder="@username –≤ Telegram (–ø–æ –∂–µ–ª–∞–Ω–∏—é)" />
      <input id="phoneInput" type="tel" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" />
      <input id="addressInput" type="text" placeholder="–ê–¥—Ä–µ—Å" />
      <textarea id="commentInput" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>

      <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
    </div>

    <div class="total" id="totalBox">–ò—Ç–æ–≥–æ: 0 Kƒç</div>
  </aside>

  <script>
    // ‚õ≥ 1) –í–°–¢–ê–í–¨ –°–í–û–ô URL –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Apps Script
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx4P7kHLxXLoKydNMzkqOumae5FpXyNACs1iI7MbBSsDBNNpvQsSby0njaB3BjNbMeRsQ/exec';

    // --- –î–ï–ú–û-–ù–ê–ë–û–† –¢–û–í–ê–†–û–í -----------------------------------
    // –£ —Å–µ–±—è –º–æ–∂–µ—à—å –æ—Å—Ç–∞–≤–∏—Ç—å —Å–≤–æ–π –º–∞—Å—Å–∏–≤, –≤–∞–∂–Ω–æ, —á—Ç–æ–±—ã –±—ã–ª–∏ –ø–æ–ª—è:
    // id, title, price, img, cat
    const ITEMS = [
      {id:1, title:'VOEX Blueberry Bubble Gum', price:300, cat:'VOEX Blueberry Bubble Gum', img:'img/blueberry-bubble-gum.jpg.jpg'},
      {id:2, title:'VOEX Blueberry Coconut',    price:300, cat:'VOEX Blueberry Coconut',    img:'img/blueberry-coconut.jpg.jpg'},
      {id:3, title:'VOEX Green Grape Rose',      price:300, cat:'VOEX Green Grape Rose',      img:'img/green-grape-rose.jpg.jpg'},
      {id:4, title:'VOEX Jasmine Raspberry',     price:300, cat:'VOEX Jasmine Raspberry',     img:'img/jasmine-raspberry.jpg.jpg'},
      {id:5, title:'VOEX Pink Lemonade',         price:300, cat:'VOEX Pink Lemonade',         img:'img/pink-lemonade.jpg.jpg'},
    ];

    // --- –°–û–°–¢–û–Ø–ù–ò–ï --------------------------------------------
    const state = {
      cat: '–í—Å–µ',
      cart: [] // —ç–ª–µ–º–µ–Ω—Ç—ã: {id,title,price,qty, img}
    };

    const tabsEl  = document.getElementById('tabs');
    const gridEl  = document.getElementById('grid');
    const searchEl = document.getElementById('search');

    const cartEl = document.getElementById('cart');
    const cartListEl = document.getElementById('cartList');
    const totalBox = document.getElementById('totalBox');

    const overlay = document.getElementById('overlay');
    const openBtn = document.getElementById('openCart');
    const closeBtn = document.getElementById('closeCart');

    const paymentSel   = document.getElementById('paymentSel');
    const deliverySel  = document.getElementById('deliverySel');
    const nameInput    = document.getElementById('nameInput');
    const usernameInput= document.getElementById('usernameInput');
    const phoneInput   = document.getElementById('phoneInput');
    const addressInput = document.getElementById('addressInput');
    const commentInput = document.getElementById('commentInput');
    const sendBtn      = document.getElementById('sendBtn');

    const money = n => `${n} Kƒç`;

    // --- –†–ï–ù–î–ï–† –ö–ê–¢–ï–ì–û–†–ò–ô -------------------------------------
    function renderTabs(){
      const cats = ['–í—Å–µ', ...Array.from(new Set(ITEMS.map(i=>i.cat)))];
      tabsEl.innerHTML = cats.map(c => `
        <div class="tab ${c===state.cat?'active':''}" data-cat="${c}">${c}</div>
      `).join('');
    }

    // --- –†–ï–ù–î–ï–† –¢–û–í–ê–†–û–í ---------------------------------------
    function renderGrid(){
      const q = searchEl.value.trim().toLowerCase();
      let items = ITEMS.filter(it =>
        (state.cat==='–í—Å–µ' || it.cat===state.cat) &&
        (!q || it.title.toLowerCase().includes(q))
      );

      gridEl.innerHTML = items.map(it => `
        <div class="card">
          <img src="${it.img}" alt="">
          <div class="p">
            <div class="muted">${it.cat}</div>
            <div class="title">${it.title}</div>
            <div class="price">${money(it.price)}</div>
            <button onclick="add(${it.id})">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
          </div>
        </div>
      `).join('');
    }

    // --- –ö–û–†–ó–ò–ù–ê ----------------------------------------------
    function add(id){
      const it = ITEMS.find(x=>x.id===id);
      if (!it) return;
      const row = state.cart.find(x=>x.id===id);
      if (row) row.qty++;
      else state.cart.push({id:it.id, title:it.title, price:it.price, qty:1, img:it.img});
      renderCart();
    }
    function minus(id){
      const row = state.cart.find(x=>x.id===id);
      if (!row) return;
      row.qty--;
      if (row.qty<=0) state.cart = state.cart.filter(x=>x.id!==id);
      renderCart();
    }
    function removeRow(id){
      state.cart = state.cart.filter(x=>x.id!==id);
      renderCart();
    }

    function renderCart(){
      if (state.cart.length===0){
        cartListEl.innerHTML = `<div class="muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>`;
      } else {
        cartListEl.innerHTML = state.cart.map(it => `
          <div class="row">
            <div style="flex:1 1 auto">
              <div>${it.title}</div>
              <div class="muted">${money(it.price*it.qty)}</div>
            </div>
            <div class="qty">
              <button class="btn-outline" onclick="minus(${it.id})">‚àí</button>
              <div>${it.qty}</div>
              <button onclick="add(${it.id})">+</button>
              <button class="btn-outline" onclick="removeRow(${it.id})">‚úï</button>
            </div>
          </div>
        `).join('');
      }

      const total = state.cart.reduce((s,i)=>s+i.qty*i.price,0);
      totalBox.textContent = `–ò—Ç–æ–≥–æ: ${money(total)}`;
    }

    // --- –û–¢–ö–†–´–¢–ò–ï/–ó–ê–ö–†–´–¢–ò–ï –ö–û–†–ó–ò–ù–´ ----------------------------
    function openCart(){
      cartEl.classList.add('drawer_open');
      overlay.classList.add('overlay_show');
    }
    function closeCart(){
      cartEl.classList.remove('drawer_open');
      overlay.classList.remove('overlay_show');
    }

    if (openBtn)   openBtn.addEventListener('click', openCart);
    if (closeBtn)  closeBtn.addEventListener('click', closeCart);
    overlay.addEventListener('click', closeCart);
    document.addEventListener('keydown', (e)=>{ if (e.key==='Escape') closeCart(); });

    // --- –û–¢–ü–†–ê–í–ö–ê –ó–ê–ö–ê–ó–ê --------------------------------------
    async function sendOrder(){
      if (!state.cart.length){
        alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞'); return;
      }

      const order = {
        items: state.cart.map(it => ({
          id: it.id,
          title: it.title,
          qty: it.qty,
          price_total: it.qty * it.price,   // –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞
          sum: it.qty * it.price            // –Ω–∞ –≤—Å—è–∫–∏–π
        })),
        customer:{
          name: nameInput.value.trim(),
          username: (usernameInput.value || '').replace('@',''),
          phone: phoneInput.value.trim(),
          address: addressInput.value.trim(),
          comment: commentInput.value.trim()
        },
        payment: paymentSel.value,
        delivery: deliverySel.value,
        currency: 'Kƒç',
        total: state.cart.reduce((s,i)=>s+i.qty*i.price,0)
      };

      console.log('[sendOrder] payload:', order);

      try{
        const resp = await fetch(WEB_APP_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(order)
        });

        // –ü—Ä–∏ mode:no-cors –æ—Ç–≤–µ—Ç –±—É–¥–µ—Ç opaque ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.
        console.log('[sendOrder] sent, resp:', resp);
        alert('‚úÖ –ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
        // –æ—á–∏—Å—Ç–∏–º –∫–æ—Ä–∑–∏–Ω—É
        state.cart = [];
        renderCart();
        closeCart();
      }catch(err){
        console.error('[sendOrder] error:', err);
        alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: '+err.message);
      }
    }

    sendBtn.addEventListener('click', sendOrder);

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ----------------------------------------
    tabsEl.addEventListener('click', (e)=>{
      const el=e.target.closest('.tab'); if (!el) return;
      state.cat = el.dataset.cat;
      renderTabs(); renderGrid();
    });
    searchEl.addEventListener('input', ()=> renderGrid());

    renderTabs(); renderGrid(); renderCart();
  </script>
</body>
</html>
